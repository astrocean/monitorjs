!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).monitorjs=e()}(this,function(){"use strict";var a=function(){return(a=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function h(e,t,n){t.split(" ").forEach(function(t){e.addEventListener(t,n)})}function d(t,e,n){void 0===n&&(n=!1);var o=new(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)(e);return o.observe(t,{childList:!0,subtree:n}),o}function m(t){return document.querySelector(t)}function g(t,e){var n,o;Math.random()>y.get().percent||(n=y.get().reportUrl+"?"+JSON.stringify(a(a({type:t},e),{namespace:y.get().namespace})),y.get().global?y.get().global.request({url:n}):((o=new Image).src=n,h(o,"load error complete",function(){document.body.removeChild(o),o=null}),document.body.appendChild(o)))}function c(t,e,n){var o=v()-t;o>y.get().timeoutCheck&&g(e,a(a({},n),{duration:o}))}var t,e,n={namespace:"main-site",timeoutCheck:600,reportUrl:"/",percent:1,global:"undefined"!=typeof wx?wx:"undefined"!=typeof my?my:null,fs:{enable:!1,root:"root",startParam:"fs_start",maxSpace:50}},y={get:function(){return n},set:function(t){n=a(a(a({},n),t),{fs:a(a({},n.fs),t.fs||{})})}},v=Date.now.bind(Date);(e=t=t||{}).RUNTIME_ERROR="RUNTIME_ERROR",e.LOAD_TIMEOUT="LOAD_TIMEOUT",e.FS="FS";var r,u,o,i,l,s,w=t;"undefined"!=typeof window?(h(window,"error",function(t){g(w.RUNTIME_ERROR,{error:t.message,lcno:t.lineno+":"+t.colno,file:t.filename})}),"fetch"in window&&(r=window.fetch,window.fetch=function(t,e){var n=v(),o=r(t,e);return e.body instanceof FormData||o.finally(function(){return c(n,w.LOAD_TIMEOUT,{url:t,options:e})}),o}),u=XMLHttpRequest.prototype.open,o=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.open=function(t,e){for(var n=this,o=[],r=2;r<arguments.length;r++)o[r-2]=arguments[r];var i=v();return h(this,"loadend",function(){return!n.__$isUploadType&&c(i,w.LOAD_TIMEOUT,{url:e,options:{method:t}})}),u.call.apply(u,function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;for(var o=Array(t),r=0,e=0;e<n;e++)for(var i=arguments[e],a=0,c=i.length;a<c;a++,r++)o[r]=i[a];return o}([this,t,e],o))},XMLHttpRequest.prototype.send=function(t){return t instanceof FormData&&(this.__$isUploadType=!0),o.call(this,t)}):((i=y.get().global).onError(function(t){g(w.RUNTIME_ERROR,{error:t,lcno:"0:0",file:""})}),l=i.request,s=function(t){var n=t.complete,o=t.url,r=function(t,e){var n={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(n[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,o=Object.getOwnPropertySymbols(t);r<o.length;r++)e.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(t,o[r])&&(n[o[r]]=t[o[r]]);return n}(t,["complete","url"]),i=v();return l(a(a({url:o},r),{complete:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];c(i,w.LOAD_TIMEOUT,{url:o,options:{data:r.data,method:r.method}}),n&&n.apply(void 0,t)}}))},Object.defineProperty(i,"request",a(a({},Object.getOwnPropertyDescriptor(i,"request")),{get:function(){return s}})));return y.get().global||function(){var e,t=location.href.match(new RegExp(y.get().fs.startParam+"=(\\d+)")),i=t?Number(t[1]):performance.timing.navigationStart,n=history.replaceState,o=history.pushState;history.replaceState=function(){n.apply(this,arguments),e=v()},history.pushState=function(){o.apply(this,arguments),e=v()},window.addEventListener("popstate",function(t){e=v()});var a,c="__$monitor",r="__$monitoring",u=!1;function l(t){return 50*Math.round(t/50)}function s(){a&&a.stop();var n,o,r=m("[data-monitorjs-fs]");r&&r[c]||!r||(n=i,o=v(),u&&(n=e),u=!0,a=new f(r,function(t,e){g(w.FS,{name:r.getAttribute("data-monitorjs-fs"),spaces:e,ready:l(o-n),duration:l(t-n)}),a.stop(),a=null}))}document.addEventListener("DOMContentLoaded",function(){y.get().fs.enable&&(d(m("#"+y.get().fs.root),s),s())});var f=(p.prototype.stop=function(){this.$&&(this.$.disconnect(),this.$=null,this.infos=null,this.element=null)},p.prototype.try2collect=function(t){var e=this;t.forEach(function(t){[].forEach.call(t.addedNodes,function(t){1==t.nodeType&&e.cache(t)}),e.try2collectImage(t.target)})},p.prototype.try2collectImage=function(t){var e=this;if(t[r])return!1;t[r]=!0,setTimeout(function(){e.collectImage(t),t[r]=!1},50)},p.prototype.collectImage=function(t){var o=this;[].forEach.call(t.getElementsByTagName("img"),function(e){var n;e[r]||(e[r]=!0,(n=o.cache(e)).image=!0,e.complete||(n.wait=new Promise(function(t){h(e,"load complete error",function(){n.time=v(),t()})})))})},p.prototype.cache=function(t){var e={el:t,time:v()};return this.infos.push(e),e},p.prototype.analyse=function(){var n=this;this.$&&Promise.all(this.filter()).then(function(t){var e,o=[],r=(null===(e=t[0])||void 0===e?void 0:e.time)||0;0!=r?(t.sort(function(t,e){return t.top-e.top}).reduceRight(function(t,e){var n=t.top+t.height;return e.top>window.innerHeight||t.top<0?e:(e.top-n>y.get().fs.maxSpace&&o.push([n,e.top]),r=Math.max(r,t.time,e.time),e.top+e.height>n?e:t)}),n.callback(r,o)):n.stop()})},p.prototype.filter=function(){var a=this.element.getBoundingClientRect().top,c=window.innerWidth,u=[];return this.infos.forEach(function(t){var e=t.el.getBoundingClientRect(),n=e.height,o=e.top,r=e.width,i=e.left;if(t.height=n,t.top=o-a,t.image){if(c<r&&c<i)return;if(t.wait)return void u.push(t.wait.then(function(){return t.height=t.el.height,t}))}u.push(t)}),u},p);function p(t,e){var n=this;this.infos=[],this.element=t,this.callback=e,this.$=t[c]=d(this.element,this.try2collect.bind(this),!0),this.collectImage(t),setTimeout(function(){return n.analyse()},2500)}}(),{init:y.set}});
