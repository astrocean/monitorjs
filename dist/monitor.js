!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).monitorjs=e()}(this,function(){"use strict";var a=function(){return(a=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function p(e,t,n){t.split(" ").forEach(function(t){e.addEventListener(t,n)})}function h(t,e,n){return void 0===n&&(n=!1),(e=new(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)(e)).observe(t,{childList:!0,subtree:n}),e}function d(t){return document.querySelector(t)}var e={namespace:"main-site",timeoutCheck:600,reportUrl:"/",percent:1,global:"undefined"!=typeof wx?wx:"undefined"!=typeof my?my:null,fs:{enable:!1,root:"root",startParam:"fs_start",maxSpace:50}},m={get:function(){return e},set:function(t){e=a(a(a({},e),t),{fs:a(a({},e.fs),t.fs||{})})}},g=Date.now.bind(Date),o="undefined"==typeof window;(t=i=i||{}).RUNTIME_ERROR="RUNTIME_ERROR",t.LOAD_TIMEOUT="LOAD_TIMEOUT",t.FS="FS";function r(t,e){if(!(Math.random()>m.get().percent)){if(t==y.LOAD_TIMEOUT&&-1<(e.url||"").indexOf(m.get().reportUrl))return;var n,e=m.get().reportUrl+"?data="+JSON.stringify(a(a({type:t},e),{namespace:m.get().namespace}));o?m.get().global.request({url:e}):((n=new Image).src=e,p(n,"load error complete",function(){document.body.removeChild(n),n=null}),document.body.appendChild(n))}}function u(t,e,n){(t=g()-t)>m.get().timeoutCheck&&r(e,a(a({},n),{duration:t}))}var t,c,n,i,l,s,f,y=i;function v(t){return 50*Math.round(t/50)}o?((t=m.get().global).onError(function(t){r(y.RUNTIME_ERROR,{error:t,lcno:"0:0",file:""})}),c=t.request,n=function(t){var n=t.complete,o=t.url,r=function(t,e){var n={};for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]]);return n}(t,["complete","url"]),i=g();return c(a(a({url:o},r),{complete:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];u(i,y.LOAD_TIMEOUT,{url:o,options:{data:r.data,method:r.method}}),n&&n.apply(void 0,t)}}))},(i=Object.getOwnPropertyDescriptor(t,"request")).get&&(i.get=function(){return n}),i.value&&(i.value=n),Object.defineProperty(t,"request",i)):(p(window,"error",function(t){r(y.RUNTIME_ERROR,{error:t.message,lcno:t.lineno+":"+t.colno,file:t.filename})}),"fetch"in window&&(l=window.fetch,window.fetch=function(t,e){void 0===e&&(e={});var n=g(),o=l(t,e);if(e.body instanceof FormData)return o;function r(){return u(n,y.LOAD_TIMEOUT,{url:t,options:e})}return o.then(r,r),o}),s=XMLHttpRequest.prototype.open,f=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.open=function(t,e){for(var n=this,o=[],r=2;r<arguments.length;r++)o[r-2]=arguments[r];var i=g();return p(this,"loadend",function(){return!n.__$isUploadType&&u(i,y.LOAD_TIMEOUT,{url:e,options:{method:t}})}),s.call.apply(s,function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;for(var o=Array(t),r=0,e=0;e<n;e++)for(var i=arguments[e],a=0,u=i.length;a<u;a++,r++)o[r]=i[a];return o}([this,t,e],o))},XMLHttpRequest.prototype.send=function(t){return t instanceof FormData&&(this.__$isUploadType=!0),f.call(this,t)});function w(t,e,n,o){void 0===e&&(e=0),void 0===n&&(n=0),void 0===o&&(o=[]),r(y.FS,{name:t,spaces:o,duration:v(e),ready:v(n)})}return o||function(){var e,t=location.href.match(new RegExp(m.get().fs.startParam+"=(\\d+)")),i=t?Number(t[1]):performance.timing.navigationStart,n=history.replaceState,o=history.pushState;history.replaceState=function(){n.apply(this,arguments),e=g()},history.pushState=function(){o.apply(this,arguments),e=g()},window.addEventListener("popstate",function(t){e=g()});var a,u="__$monitor",r="__$monitoring",c=!1;function l(){a&&a.stop();var n,o,r=d("[data-monitorjs-fs]");r&&r[u]||!r||(n=i,o=g(),c&&(n=e),c=!0,a=new s(r,function(t,e){w(r.getAttribute("data-monitorjs-fs"),t-n,o-n,e),a.stop(),a=null}))}document.addEventListener("DOMContentLoaded",function(){m.get().fs.enable&&(h(d("#"+m.get().fs.root),l),l())});var s=(f.prototype.stop=function(){this.$&&(this.$.disconnect(),this.$=null,this.infos=null,this.element=null)},f.prototype.try2collect=function(t){var e=this;t.forEach(function(t){[].forEach.call(t.addedNodes,function(t){1==t.nodeType&&e.cache(t)}),e.try2collectImage(t.target)})},f.prototype.try2collectImage=function(t){var e=this;if(t[r])return!1;t[r]=!0,setTimeout(function(){e.collectImage(t),t[r]=!1},50)},f.prototype.collectImage=function(t){var o=this;[].forEach.call(t.getElementsByTagName("img"),function(e){var n;e[r]||(e[r]=!0,(n=o.cache(e)).image=!0,e.complete||(n.wait=new Promise(function(t){p(e,"load complete error",function(){n.time=g(),t()})})))})},f.prototype.cache=function(t){t={el:t,time:g()};return this.infos.push(t),t},f.prototype.analyse=function(){var n=this;this.$&&Promise.all(this.filter()).then(function(t){var e,o=[],r=(null===(e=t[0])||void 0===e?void 0:e.time)||0;0!=r?(t.sort(function(t,e){return t.top-e.top}).reduceRight(function(t,e){var n=t.top+t.height;return e.top>window.innerHeight||t.top<0?e:(e.top-n>m.get().fs.maxSpace&&o.push([n,e.top]),r=Math.max(r,t.time,e.time),e.top+e.height>n?e:t)}),n.callback(r,o)):n.stop()})},f.prototype.filter=function(){var i=this.element.getBoundingClientRect().top,a=window.innerWidth,u=[];return this.infos.forEach(function(t){var e=t.el.getBoundingClientRect(),n=e.height,o=e.top,r=e.width,e=e.left;if(t.height=n,t.top=o-i,t.image){if(a<r&&a<e)return;if(t.wait)return void u.push(t.wait.then(function(){return t.height=t.el.height,t}))}u.push(t)}),u},f);function f(t,e){var n=this;this.infos=[],this.element=t,this.callback=e,this.$=t[u]=h(this.element,this.try2collect.bind(this),!0),this.collectImage(t),setTimeout(function(){return n.analyse()},2500)}}(),{init:m.set,reportFs:w}});
