!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).monitorjs=e()}(this,function(){"use strict";var r=function(){return(r=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function a(e,t,n){t.split(" ").forEach(function(t){e.addEventListener(t,n)})}function o(t,e,n){void 0===n&&(n=!0);var o=new f(e);return o.observe(t,{childList:!0,subtree:n}),o}function t(t){return document.querySelector(t)}function i(t,e){var n;Math.random()>s.percent||((n=new Image).src=s.reportUrl+"?type="+t+"&data="+JSON.stringify(r(r({},e),{namespace:s.namespace}))+"&timestamp="+l(),a(n,"load error complete",function(){document.body.removeChild(n),n=null}),document.body.appendChild(n))}function c(t,e,n){var o=l()-t;o>s.timeoutCheck&&i(e,r(r({},n),{duration:o}))}var e,n,u={namespace:"main-site",timeoutCheck:1,reportUrl:"/",percent:1,fs:{enable:!0,root:"root",startParam:"fs_start",maxSpace:50}},s=u,f=window.MutationObserver,l=Date.now.bind(Date);(n=e=e||{}).RUNTIME_ERROR="RUNTIME_ERROR",n.LOAD_TIMEOUT="LOAD_TIMEOUT",n.FS="FS";var p,h=e;a(window,"error",function(t){i(h.RUNTIME_ERROR,{error:t.message,lcno:t.lineno+":"+t.colno,file:t.filename})}),"fetch"in window&&(p=window.fetch,window.fetch=function(t,e){var n=l(),o=p(t,e);return e.body instanceof FormData||o.finally(function(){return c(n,h.LOAD_TIMEOUT,{url:t,options:e})}),o});var d=XMLHttpRequest.prototype.open,m=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,e){for(var n=this,o=[],r=2;r<arguments.length;r++)o[r-2]=arguments[r];var i=l();return a(this,"loadend",function(){return!n.__$isUploadType&&c(i,h.LOAD_TIMEOUT,{url:e,options:{method:t}})}),d.call.apply(d,function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;for(var o=Array(t),r=0,e=0;e<n;e++)for(var i=arguments[e],a=0,c=i.length;a<c;a++,r++)o[r]=i[a];return o}([this,t,e],o))},XMLHttpRequest.prototype.send=function(t){return t instanceof FormData&&(this.__$isUploadType=!0),m.call(this,t)};var v=document.createElement;document.createElement=function(t){var e=v.call(this,t),n=l();return"script"==t&&a(e,"load",function(){return c(n,h.LOAD_TIMEOUT,{url:e.src})}),e};var y,g=location.href.match(new RegExp(s.fs.startParam+"=(\\d+)")),w=g?Number(g[1]):performance.timing.navigationStart,E=!1,R=history.replaceState,O=history.pushState;history.replaceState=function(){R.apply(this,arguments),y=l()},history.pushState=function(){O.apply(this,arguments),y=l()},window.addEventListener("popstate",function(t){y=l()});var T="__$monitor",_="__$monitoring";function b(){var n=t("[data-monitorjs-fs]");n&&n[T]||!n||(E&&(w=y),E=!0,new M(n,function(t,e){i(h.FS,{name:n.getAttribute("data-monitorjs-fs"),duration:t-w})}))}document.addEventListener("DOMContentLoaded",function(){o(t("#"+s.fs.root),b),b()});var M=(I.prototype.try2collect=function(t){var e=this;t.forEach(function(t){[].forEach.call(t.addedNodes,function(t){1==t.nodeType&&e.cache(t)}),e.try2collectImage(t.target)})},I.prototype.try2collectImage=function(t){var e=this;if(t[_])return!1;t[_]=!0,setTimeout(function(){e.collectImage(t),t[_]=!1},50)},I.prototype.collectImage=function(t){var o=this;[].forEach.call(t.getElementsByTagName("img"),function(e){var n;e[_]||(e[_]=!0,(n=o.cache(e)).image=!0,e.complete||(n.wait=new Promise(function(t){a(e,"load complete error",function(){n.time=l(),t()})})))})},I.prototype.cache=function(t){var e={el:t,time:l()};return this.infos.push(e),e},I.prototype.analyse=function(){var n=this;this.$.disconnect(),Promise.all(this.filter()).then(function(t){var e,o=[],r=(null===(e=t[0])||void 0===e?void 0:e.time)||0;0!=r&&(t.sort(function(t,e){return t.top-e.top}).reduceRight(function(t,e){var n=t.top+t.height;return e.top>window.innerHeight||t.top<0?e:(e.top-n>s.fs.maxSpace&&o.push([n,e.top]),r=Math.max(r,t.time,e.time),e.top+e.height>n?e:t)}),n.callback(r,o))})},I.prototype.filter=function(){var a=this.element.getBoundingClientRect().top,c=window.innerWidth,u=[];return this.infos.forEach(function(t){var e=t.el.getBoundingClientRect(),n=e.height,o=e.top,r=e.width,i=e.left;if(t.height=n,t.top=o-a,t.image){if(c<r&&c<i)return;if(t.wait)return void u.push(t.wait.then(function(){return t.height=t.el.height,t}))}u.push(t)}),u},I);function I(t,e){var n=this;this.infos=[],this.element=t,this.callback=e,this.$=t[T]=o(this.element,this.try2collect.bind(this),!0),this.collectImage(t),setTimeout(function(){return n.analyse()},2500)}return{init:function(t){var e;e=t,u=r(r({},u),e)}}});
